# OLS Viikkopelit Admin (`admin_app`)

This application is a microservice responsible for managing the OLS Viikkopelit game data using **LiteFS distributed SQLite architecture**. Its primary functions include:
- Fetching the latest Viikkopelit PDF schedule from the OLS website.
- Parsing the PDF content into a structured format.
- Extracting detailed game information and storing them in a **LiteFS primary database**.
- **Real-time replication** to the main `ols-viikkopelit` viewer application via LiteFS clustering.
- Offering an admin dashboard to trigger data updates and view processing history.

## üèóÔ∏è LiteFS Primary Node Architecture

This admin app serves as the **LiteFS primary node** in a distributed database cluster:

- **Role**: Primary (read/write) - handles all database writes and PDF processing
- **LiteFS Config**: `candidate: true`, `promote: true` - automatically becomes cluster primary
- **Replication**: Automatically syncs all data changes to replica nodes in real-time
- **Failover**: Can hand off primary role to other candidate nodes if needed
- **Consul Coordination**: Uses shared Consul cluster for primary election and node discovery

**Clustering Benefits:**
- üåç **Global Distribution**: Replicas can be deployed in multiple Fly.io regions
- ‚ö° **Real-time Sync**: Database changes propagate to replicas within milliseconds
- üîÑ **High Availability**: Automatic failover if primary node goes down
- üìä **Consistent Reads**: ACID transactions with eventual consistency across replicas

## Key Modules & Functionality

The `admin_app/src/` directory contains the core logic:

- **`admin_app.ts`**: The main Express.js server. It sets up the routes for the admin dashboard, API endpoints for data retrieval, and triggers for data processing tasks.
- **`database.ts`**: Database management module using **LiteFS-mounted SQLite**. Handles game data storage on the primary node, processing history, and provides methods for querying and updating the distributed database. All writes automatically replicate to replica nodes.
- **`updateLatestPdf.ts`**: Contains the Puppeteer logic to scrape the OLS website (`https://ols.fi/jalkapallo/viikkopelit/`) and download the latest PDF schedule. It saves the PDF to the persistent storage.
- **`pdfParser.ts`**: Uses the `pdf2json` library to convert the raw PDF file into a structured JSON object. This JSON includes text elements and their coordinates, making it easier to process.
- **`dataExtractor.ts`**: Implements the primary logic to process the parsed PDF data, identify game blocks, headers (like team names, year/league), and extract individual game details (time, teams, field). Data is saved directly to the **LiteFS primary database** and automatically replicates to all replica nodes.
- **`gameDataExtractor.ts`**: Contains utility functions for data validation, summary generation, and database querying used by the admin dashboard.
- **`pageParserUtils.ts`**: A collection of utility functions that assist in navigating and interpreting the structured data generated by `pdfParser.ts`. These might include functions for finding text by coordinates, grouping elements, etc.
- **`generateGamesSummary.ts`**: A script to read games from the database and generate a human-readable summary text file (`games_summary.txt`) for quick review.
- **`input.css`**: Tailwind CSS input file for styling the admin dashboard.
- **`routes/uploadRoutes.ts`**: Handles manual PDF uploads. Provides an endpoint for uploading PDF files directly to the server, protected by a password. This is useful if automatic fetching fails or a specific PDF version needs to be processed.

## Local Development Setup

*   **Prerequisites:** Node.js, npm. For Puppeteer, a local installation of Chromium is typically needed if not running via Docker.
*   **Installation:**
    ```bash
    # Navigate to the admin_app subdirectory
    cd /path/to/ols-viikkopelit/admin_app
    npm install
    ```
*   **Environment (Local):**
    *   This app uses `APP_PERSISTENT_STORAGE_PATH` to know where to save downloaded PDFs and the SQLite database (`games.db`). Locally, it defaults to a path relative to its own `admin_app.ts` (e.g., `admin_app/persistent_app_files/`). You might want to use a `.env` file with `dotenv` to manage this, `API_ACCESS_KEY` for local testing of its API, and `UPLOAD_PASSWORD` for the manual PDF upload feature.
*   **Build:**
    ```bash
    npm run build # Compiles TypeScript and Tailwind CSS
    ```
*   **Run:**
    ```bash
    npm start # Runs from dist/
    # OR for development with auto-rebuilds and CSS watching:
    npm run dev
    ```
    The admin app will be available at `http://localhost:3003` (or as configured).
    *   You can then access its dashboard to trigger PDF scraping and processing. The game data will be stored in the SQLite database (`games.db`) in the configured persistent storage path.

## Available NPM Scripts

- **`npm start`**: Runs the compiled application from the `dist/` directory.
- **`npm run build`**: Compiles TypeScript code to JavaScript (in `dist/`) and builds the Tailwind CSS (`public/css/style.css` from `src/input.css`).
- **`npm run build:css`**: Specifically builds the Tailwind CSS.
- **`npm run dev`**: Runs the application in development mode. This includes watching TypeScript files for changes (recompiling on save), watching the CSS input file, and restarting the Node.js server automatically.
- **`npm run update-data`**: Executes the `src/updateLatestPdf.ts` script directly using `ts-node` to download the latest PDF.
- **`npm run parse-pdf`**: Executes the `src/pdfParser.ts` script directly using `ts-node` to parse a downloaded PDF.
- **`npm run extract-data`**: Executes the `src/dataExtractor.ts` script directly using `ts-node` to extract game data from a parsed PDF and save to database.
- **`npm run generate-summary`**: Executes the `src/generateGamesSummary.ts` script directly using `ts-node` to create the games summary file from database data.

## Tech Stack

- **Backend Framework**: Express.js
- **Database**: **LiteFS Distributed SQLite** (Primary Node)
- **Language**: TypeScript
- **Web Scraping**: Puppeteer (with Chromium)
- **PDF Parsing**: `pdf2json`
- **Styling (Admin Dashboard)**: Tailwind CSS
- **Templating (Admin Dashboard)**: EJS
- **Clustering**: LiteFS with Consul coordination
- **Deployment**: Fly.io with persistent volumes

## üöÄ LiteFS Deployment & Clustering

This admin app is configured as a **LiteFS primary node**. Here's how to set up the distributed database cluster:

### **Prerequisites**
- Fly.io CLI installed and authenticated
- Both admin and main apps created on Fly.io
- Persistent volumes created for both apps

### **LiteFS Clustering Setup**

1. **Deploy Admin App (Primary) First:**
   ```bash
   cd admin_app
   fly consul attach -a ols-viikkopelit-admin  # Creates shared Consul cluster
   fly deploy -a ols-viikkopelit-admin
   ```

2. **Retrieve Consul URL:**
   ```bash
   fly ssh console -a ols-viikkopelit-admin
   echo $FLY_CONSUL_URL  # Copy this complete URL
   exit
   ```

3. **Configure Main App (Replica):**
   ```bash
   cd ..  # Back to project root
   fly secrets set FLY_CONSUL_URL="<paste-exact-consul-url>" -a ols-viikkopelit
   fly deploy -a ols-viikkopelit
   ```

4. **Verify Clustering:**
   ```bash
   # Both apps should have identical Consul URL digests
   fly secrets list -a ols-viikkopelit-admin
   fly secrets list -a ols-viikkopelit
   
   # Check logs for successful clustering
   fly logs -a ols-viikkopelit-admin  # Should show "promoting to primary"
   fly logs -a ols-viikkopelit        # Should show "connected to cluster"
   ```

### **LiteFS Configuration**

The admin app uses this LiteFS configuration (`litefs.yml`):
```yaml
lease:
  type: "consul"
  candidate: true    # Can become primary
  promote: true      # Automatically promote to primary
  consul:
    url: "${FLY_CONSUL_URL}"
    key: "ols-viikkopelit-cluster/primary"
```

**Key Settings:**
- `candidate: true` - This node can become the primary writer
- `promote: true` - Automatically becomes primary on startup
- `fuse.dir: "/litefs"` - Database mounted at `/litefs/games.db`
- `proxy.addr: ":8080"` - LiteFS proxy for write redirection

### **Troubleshooting LiteFS**

**Common Issues:**
- **"Connection refused 127.0.0.1:8500"**: Environment variable `FLY_CONSUL_URL` is empty or incorrect
- **Different Consul URLs**: Check `fly secrets list` - both apps must have identical digest values
- **Primary not elected**: Check admin app logs for Consul connection errors

**Debug Commands:**
```bash
# Check environment variables inside container
fly ssh console -a ols-viikkopelit-admin
printenv | grep CONSUL

# Monitor LiteFS startup
fly logs -a ols-viikkopelit-admin -f

# Verify database replication
fly ssh console -a ols-viikkopelit
ls -la /litefs/  # Should show games.db
```

This `README.md` provides a focused overview of the LiteFS-enabled admin app. For details on the overall distributed architecture and main viewer app configuration, please refer to the [main project README.md](../README.md).
