# OLS Viikkopelit Admin (`admin_app`)

This application is a microservice responsible for managing the OLS Viikkopelit game data. Its primary functions include:
- Fetching the latest Viikkopelit PDF schedule from the OLS website.
- Parsing the PDF content into a structured format.
- Extracting detailed game information.
- Providing an API endpoint for the main `ols-viikkopelit` viewer application to consume this data.
- Offering an admin dashboard to trigger data updates and view logs.

## Key Modules & Functionality

The `admin_app/src/` directory contains the core logic:

- **`admin_app.ts`**: The main Express.js server. It sets up the routes for the admin dashboard, API endpoints for data retrieval, and triggers for data processing tasks.
- **`updateLatestPdf.ts`**: Contains the Puppeteer logic to scrape the OLS website (`https://ols.fi/jalkapallo/viikkopelit/`) and download the latest PDF schedule. It saves the PDF to the persistent storage.
- **`pdfParser.ts`**: Uses the `pdf2json` library to convert the raw PDF file into a structured JSON object (`parsed_pdf_data.json`). This JSON includes text elements and their coordinates, making it easier to process.
- **`dataExtractor.ts`**: Implements the primary logic to read `parsed_pdf_data.json`, identify game blocks, headers (like team names, year/league), and extract individual game details (time, teams, field).
- **`gameDataExtractor.ts`**: Contains more specific utility functions and refined logic used by `dataExtractor.ts` to accurately parse game information from the structured PDF data.
- **`pageParserUtils.ts`**: A collection of utility functions that assist in navigating and interpreting the structured data generated by `pdfParser.ts`. These might include functions for finding text by coordinates, grouping elements, etc.
- **`generateGamesSummary.ts`**: A script to process the `extracted_games_output.json` and generate a human-readable summary text file (`games_summary.txt`), potentially for quick review or logging.
- **`input.css`**: Tailwind CSS input file for styling the admin dashboard.

## Local Development Setup

*   **Prerequisites:** Node.js, npm. For Puppeteer, a local installation of Chromium is typically needed if not running via Docker.
*   **Installation:**
    ```bash
    # Navigate to the admin_app subdirectory
    cd /path/to/ols-viikkopelit/admin_app
    npm install
    ```
*   **Environment (Local):**
    *   This app uses `APP_PERSISTENT_STORAGE_PATH` to know where to save downloaded PDFs and generated JSON. Locally, it defaults to a path relative to its own `admin_app.ts` (e.g., `admin_app/persistent_app_files_admin/`). You might want to use a `.env` file with `dotenv` to manage this and `API_ACCESS_KEY` for local testing of its API.
*   **Build:**
    ```bash
    npm run build # Compiles TypeScript and Tailwind CSS
    ```
*   **Run:**
    ```bash
    npm start # Runs from dist/
    # OR for development with auto-rebuilds and CSS watching:
    npm run dev
    ```
    The admin app will be available at `http://localhost:3003` (or as configured).
    *   You can then access its dashboard to trigger PDF scraping and processing. The output `extracted_games_output.json` will be in its configured persistent storage path.

## Available NPM Scripts

- **`npm start`**: Runs the compiled application from the `dist/` directory.
- **`npm run build`**: Compiles TypeScript code to JavaScript (in `dist/`) and builds the Tailwind CSS (`public/css/style.css` from `src/input.css`).
- **`npm run build:css`**: Specifically builds the Tailwind CSS.
- **`npm run dev`**: Runs the application in development mode. This includes watching TypeScript files for changes (recompiling on save), watching the CSS input file, and restarting the Node.js server automatically.
- **`npm run update-data`**: Executes the `src/updateLatestPdf.ts` script directly using `ts-node` to download the latest PDF.
- **`npm run parse-pdf`**: Executes the `src/pdfParser.ts` script directly using `ts-node` to parse a downloaded PDF.
- **`npm run extract-data`**: Executes the `src/dataExtractor.ts` script directly using `ts-node` to extract game data from a parsed PDF JSON.
- **`npm run generate-summary`**: Executes the `src/generateGamesSummary.ts` script directly using `ts-node` to create the games summary file.

## Tech Stack

- **Backend Framework**: Express.js
- **Language**: TypeScript
- **Web Scraping**: Puppeteer (with Chromium)
- **PDF Parsing**: `pdf2json`
- **Styling (Admin Dashboard)**: Tailwind CSS
- **Templating (Admin Dashboard)**: EJS

This `README.md` provides a focused overview of the `admin_app`. For details on the overall project architecture, data flow between `admin_app` and the main viewer app, deployment, and Dockerization, please refer to the [main project README.md](../../README.md).
