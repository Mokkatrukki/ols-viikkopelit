<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="<%= metaDescription %>">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title><%= documentTitle %></title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="<%= metaUrl %>">
    <meta property="og:title" content="<%= metaTitle %>">
    <meta property="og:description" content="<%= metaDescription %>">
    <meta property="og:site_name" content="Talviliiga">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="<%= metaUrl %>">
    <meta property="twitter:title" content="<%= metaTitle %>">
    <meta property="twitter:description" content="<%= metaDescription %>">

    <!-- Critical CSS inlined for fast render -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.5; }

        .min-h-screen { min-height: 100vh; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-grow { flex-grow: 1; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .container { width: 100%; margin-left: auto; margin-right: auto; }
        .max-w-3xl { max-width: 48rem; }
        .w-full { width: 100%; }
        .block { display: block; }

        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-12 { margin-top: 3rem; }

        .bg-white { background-color: rgb(255 255 255); }
        .bg-blue-700 { background-color: rgb(29 78 216); }
        .bg-slate-100 { background-color: rgb(241 245 249); }
        .bg-slate-800 { background-color: rgb(30 41 59); }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-blue-50 { --tw-gradient-from: rgb(239 246 255); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgb(239 246 255 / 0)); }
        .to-slate-50 { --tw-gradient-to: rgb(248 250 252); }

        .text-white { color: rgb(255 255 255); }
        .text-blue-800 { color: rgb(30 64 175); }
        .text-blue-700 { color: rgb(29 78 216); }
        .text-slate-600 { color: rgb(71 85 105); }
        .text-slate-700 { color: rgb(51 65 85); }
        .text-slate-800 { color: rgb(30 41 59); }
        .text-slate-300 { color: rgb(203 213 225); }

        .border { border-width: 1px; }
        .border-2 { border-width: 2px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-l-4 { border-left-width: 4px; }
        .border-blue-400 { border-color: rgb(96 165 250); }
        .border-blue-500 { border-color: rgb(59 130 246); }
        .border-blue-600 { border-color: rgb(37 99 235); }
        .border-slate-300 { border-color: rgb(203 213 225); }

        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .uppercase { text-transform: uppercase; }
        .tracking-wide { letter-spacing: 0.025em; }
        .mb-1 { margin-bottom: 0.25rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .justify-center { justify-content: center; }

        .rounded-lg { border-radius: 0.5rem; }
        .rounded-b-lg { border-bottom-right-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        .rounded-t-lg { border-top-right-radius: 0.5rem; border-top-left-radius: 0.5rem; }

        .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        select { font-family: inherit; font-size: 100%; padding: 0.75rem; width: 100%; border: 1px solid rgb(203 213 225); border-radius: 0.5rem; }
        option.base-team { font-weight: 700 !important; }

        /* Searchable Select Styles */
        .searchable-select-wrapper { position: relative; width: 100%; }
        .searchable-select-input {
            width: 100%;
            padding: 0.75rem;
            padding-right: 2.5rem;
            border: 1px solid rgb(203 213 225);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        .searchable-select-input:focus {
            outline: 2px solid rgb(59 130 246);
            outline-offset: -1px;
        }
        .searchable-select-arrow {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: rgb(71 85 105);
        }
        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background: white;
            border: 1px solid rgb(203 213 225);
            border-radius: 0.5rem;
            max-height: 20rem;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            z-index: 50;
            display: none;
        }
        .searchable-select-dropdown.open { display: block; }
        .searchable-select-option {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid rgb(241 245 249);
        }
        .searchable-select-option:hover {
            background-color: rgb(239 246 255);
        }
        .searchable-select-option:last-child { border-bottom: none; }
        .searchable-select-option.selected {
            background-color: rgb(219 234 254);
            font-weight: 600;
        }
        .searchable-select-option.base-team {
            font-weight: 700;
            color: rgb(30 64 175);
        }
        .searchable-select-option.subteam {
            padding-left: 2rem;
            color: rgb(71 85 105);
        }
        .searchable-select-option.hidden { display: none; }

        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }

        @media (min-width: 768px) {
            .md\\:p-8 { padding: 2rem; }
            .md\\:text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        }
    </style>

    <link rel="preload" href="/css/style.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/css/style.min.css"></noscript>
</head>

<body class="bg-slate-100 text-slate-800 flex flex-col min-h-screen">
    <div class="container max-w-3xl flex-col flex-grow w-full">
        <header class="bg-blue-700 text-white p-4 rounded-b-lg shadow-md">
            <% if (gamesByDate && gamesByDate.length > 0 && typeof selectedDate !== 'undefined' && selectedDate) { %>
                <% const currentIdx = typeof currentDateIndex !== 'undefined' ? currentDateIndex : gamesByDate.findIndex(d => d.date === selectedDate); %>
                <% const currentDateGroup = gamesByDate[currentIdx]; %>
                <% const prevDate = currentIdx > 0 ? gamesByDate[currentIdx - 1] : null; %>
                <% const nextDate = currentIdx < gamesByDate.length - 1 ? gamesByDate[currentIdx + 1] : null; %>

                <div class="flex items-center justify-between">
                    <% if (prevDate) { %>
                        <a href="<%= selectedTeam ? '/team/' + encodeURIComponent(selectedTeam) + '?date=' + encodeURIComponent(prevDate.date) : '/date/' + encodeURIComponent(prevDate.date) %>" class="text-white text-2xl hover:text-blue-200">&lt;</a>
                    <% } else { %>
                        <span class="text-2xl text-blue-500">&lt;</span>
                    <% } %>

                    <h1 class="text-xl md:text-2xl font-bold text-center flex-grow">
                        Talviliiga - <%= currentDateGroup ? currentDateGroup.fullDate : selectedDate %>
                    </h1>

                    <% if (nextDate) { %>
                        <a href="<%= selectedTeam ? '/team/' + encodeURIComponent(selectedTeam) + '?date=' + encodeURIComponent(nextDate.date) : '/date/' + encodeURIComponent(nextDate.date) %>" class="text-white text-2xl hover:text-blue-200">&gt;</a>
                    <% } else { %>
                        <span class="text-2xl text-blue-500">&gt;</span>
                    <% } %>
                </div>
            <% } else { %>
                <h1 class="text-2xl md:text-3xl font-bold text-center">
                    <%= documentTitle %>
                </h1>
            <% } %>
        </header>

        <main class="p-4 md:p-8 mt-4 flex-grow">
            <form method="GET" id="teamSelectionForm" class="mb-6">
                <label for="teamSearch" class="block text-lg font-medium text-blue-800 mb-2">Valitse joukkue:</label>
                <div class="searchable-select-wrapper">
                    <input
                        type="text"
                        id="teamSearch"
                        class="searchable-select-input"
                        placeholder="-- Kaikki joukkueet --"
                        autocomplete="off"
                        value="<%= selectedTeam ? selectedTeam : '' %>"
                    >
                    <span class="searchable-select-arrow">▼</span>
                    <div id="teamDropdown" class="searchable-select-dropdown">
                        <div class="searchable-select-option" data-value="">-- Kaikki joukkueet --</div>
                        <% groupedTeams.forEach(group => { %>
                            <% group.baseTeams.forEach(baseTeam => { %>
                                <div class="searchable-select-option base-team"
                                     data-value="base-team:<%= baseTeam.name %>"
                                     data-fullname="<%= baseTeam.name %>"
                                     data-search="<%= baseTeam.name.toLowerCase() %>">
                                    ● <%= baseTeam.name %>
                                </div>
                                <% baseTeam.subteams.forEach(subteam => { %>
                                    <% const subteamSuffix = subteam.substring(baseTeam.name.length).trim(); %>
                                    <div class="searchable-select-option subteam <%= selectedTeam === subteam ? 'selected' : '' %>"
                                         data-value="<%= subteam %>"
                                         data-fullname="<%= subteam %>"
                                         data-search="<%= subteam.toLowerCase() %> <%= subteamSuffix.toLowerCase() %>">
                                        <%= baseTeam.name %> - <%= subteamSuffix %>
                                    </div>
                                <% }); %>
                            <% }); %>
                            <% group.individualTeams.forEach(team => { %>
                                <div class="searchable-select-option <%= selectedTeam === team ? 'selected' : '' %>"
                                     data-value="<%= team %>"
                                     data-fullname="<%= team %>"
                                     data-search="<%= team.toLowerCase() %>">
                                    <%= team %>
                                </div>
                            <% }); %>
                        <% }); %>
                    </div>
                </div>
            </form>

            <script>
                const currentDate = '<%= typeof selectedDate !== "undefined" && selectedDate ? selectedDate : "" %>';
                const searchInput = document.getElementById('teamSearch');
                const dropdown = document.getElementById('teamDropdown');
                const options = dropdown.querySelectorAll('.searchable-select-option');

                // Toggle dropdown on input click and select all text for easy replacement
                searchInput.addEventListener('click', function() {
                    dropdown.classList.toggle('open');
                    // Select all text so typing replaces it (especially useful on mobile)
                    this.select();
                });

                // Also select all when focused (e.g., via tab key)
                searchInput.addEventListener('focus', function() {
                    // Small delay to ensure selection works on mobile
                    setTimeout(() => this.select(), 10);
                });

                // Filter options as user types
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    dropdown.classList.add('open');

                    options.forEach(option => {
                        const searchData = option.getAttribute('data-search') || '';
                        if (searchTerm === '' || searchData.includes(searchTerm)) {
                            option.classList.remove('hidden');
                        } else {
                            option.classList.add('hidden');
                        }
                    });
                });

                // Handle option selection
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        const fullName = this.getAttribute('data-fullname');

                        // Update input
                        if (value === '') {
                            searchInput.value = '';
                            searchInput.placeholder = '-- Kaikki joukkueet --';
                        } else {
                            // Use full name if available, otherwise use cleaned text
                            searchInput.value = fullName || this.textContent.trim().replace('●', '').replace('-', '').trim();
                        }

                        // Close dropdown
                        dropdown.classList.remove('open');

                        // Navigate
                        handleTeamSelection(value);
                    });
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!searchInput.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('open');
                    }
                });

                // Handle keyboard navigation
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        dropdown.classList.remove('open');
                    }
                });

                function handleTeamSelection(value) {
                    if (!value) {
                        if (currentDate) {
                            window.location.href = '/date/' + encodeURIComponent(currentDate);
                        } else {
                            window.location.href = '/';
                        }
                    } else if (value.startsWith('base-team:')) {
                        // Navigate to base team portal
                        const baseTeamName = value.substring('base-team:'.length);
                        window.location.href = '/base-team/' + encodeURIComponent(baseTeamName);
                    } else {
                        // Navigate to individual team page
                        if (currentDate) {
                            window.location.href = '/team/' + encodeURIComponent(value) + '?date=' + encodeURIComponent(currentDate);
                        } else {
                            window.location.href = '/team/' + encodeURIComponent(value);
                        }
                    }
                }
            </script>

            <% if (typeof loading !== 'undefined' && loading) { %>
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full border-b-2 border-blue-700" style="width: 2rem; height: 2rem;"></div>
                    <p class="mt-4 text-lg text-blue-800">Ladataan turnaustietoja...</p>
                    <p class="text-sm text-slate-600 mt-2">Palvelin käynnistyy, odota hetki.</p>
                </div>
                <script>
                    let retryCount = 0;
                    const maxRetries = 10;

                    function checkForData() {
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        }
                    }

                    checkForData();
                </script>
            <% } else if (selectedTeam && gamesForTeam.length > 0) { %>
                <h2 class="text-2xl font-semibold text-blue-800 mb-4 text-center">
                    <% if (typeof teamNameSplit !== 'undefined' && teamNameSplit.parent && teamNameSplit.subteam) { %>
                        <a href="/base-team/<%= encodeURIComponent(teamNameSplit.parent) %>" class="hover:text-blue-600 underline"><%= teamNameSplit.parent %></a> / <%= teamNameSplit.subteam %> - Otteluohjelma
                    <% } else { %>
                        <%= selectedTeam %> - Otteluohjelma
                    <% } %>
                </h2>

                <div class="space-y-6">
                    <% gamesForTeam.forEach((game, index) => { %>
                        <% if (game.breakDurationMinutes && game.breakDurationMinutes > 0) { %>
                            <div class="bg-white p-4 rounded-lg shadow-lg my-4 flex items-center justify-center">
                                <div class="text-center">
                                    <p class="text-sm font-semibold text-blue-800 uppercase tracking-wide mb-1">Tauko</p>
                                    <p class="text-2xl font-bold text-blue-700"><%= game.breakDurationMinutes %> min</p>
                                </div>
                            </div>
                        <% } %>

                        <div class="bg-white p-5 rounded-lg shadow-xl border border-blue-600">
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <% if (game.fullDate) { %>
                                    <p class="text-lg font-bold text-slate-700"><%= game.fullDate %></p>
                                    <% } else { %>
                                    <p class="text-lg font-bold text-slate-700"><%= game.date %></p>
                                    <% } %>
                                    <p class="text-xl font-bold text-blue-700"><%= game.time %></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-slate-600"><%= game.location %></p>
                                    <p class="text-lg font-semibold text-slate-700"><%= game.field %></p>
                                </div>
                            </div>

                            <div class="mb-2">
                                <p class="text-md text-slate-800">
                                    <span class="font-bold text-blue-700"><%= selectedTeam %></span> vs
                                    <span class="text-slate-700"><%= game.opponent %></span>
                                </p>
                            </div>

                            <div class="text-sm text-slate-600 mt-3 pt-3 border-t border-slate-200" style="border-top-width: 1px;">
                                <span class="font-semibold">Pelimuoto:</span> <%= game.gameType %> &nbsp;&middot;&nbsp;
                                <span class="font-semibold">Kesto:</span> <%= game.gameDuration %>
                            </div>

                            <%
                            const locationFieldKey = `${game.location.toUpperCase()} ${game.field.toUpperCase()}`.replace(/\s+/g, ' ').trim();
                            const fieldImageData = fieldMapData[locationFieldKey];
                            if (fieldImageData) {
                            %>
                                <div class="mt-4 border border-slate-300 rounded-lg overflow-hidden">
                                    <img
                                        src="<%= fieldImageData.src %>"
                                        alt="Kenttäkartta - <%= game.location %> <%= game.field %>"
                                        class="block w-full"
                                        width="<%= fieldImageData.width %>"
                                        height="<%= fieldImageData.height %>"
                                        loading="<%= index === 0 ? 'eager' : 'lazy' %>">
                                </div>
                            <% } %>
                        </div>
                    <% }); %>
                </div>
            <% } else if (selectedTeam) { %>
                <p class="text-center text-slate-500 mt-10 text-lg">Ei pelejä valitulle joukkueelle.</p>
            <% } else { %>
                <p class="text-center text-slate-500 mt-10 text-lg">Valitse joukkue nähdäksesi otteluohjelman.</p>
            <% } %>
        </main>

        <footer class="bg-slate-800 text-slate-300 text-center p-4 rounded-t-lg mt-12 shadow-inner">
            <p>Tämä on epävirallinen työkalu Talviliigan otteluohjelman selaamiseen.</p>
        </footer>
    </div>
</body>
</html>
